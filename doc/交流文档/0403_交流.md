# 0403_交流

## 出租车部分的实验讨论

讨论结果：完成周畅学姐实验需求里的2.1部分，进行地图数据选取。
需要从周畅学姐处获取：geohash和具体区域对应的网页网址

## 1.connection not open on send() 问题的尝试

![systemPicture](../question_pic/2023-04-03.png)
![theFirstTry](../question_pic/2023-04-03%20(1).png)
在手册里，把 `rpcaddr` 从`127.0.0.1` 修改为 `0.0.0.0`，但是只修改了启动区块链的指令，依然无法和区块链进行交互

* 有可能需要在`初始化区块链`的时候就进行修改？
  * reply：也许是，晚上尝试它

## 2.调试过程中出现的问题 **out of gas**

换了好几种地图，都出现了这个问题。
![system1](../question_pic/2023-04-02.png)
![system2](../question_pic/2023-04-02%20(1).png)
![system3](../question_pic/2023-04-02%20(2).png)
![errorPosition](../question_pic/2023-04-02%20(3).png)
按照代码部分来看，报在第155行第51列，应该是指这个trafficContract的部分，就是和区块链交互的部分，不知道为什么gas出问题。
在之前vehicle、passenger初始化位置不对的时候，是不报这个错的。
现在把vehicle、passenger初始化的位置放到路上之后，报了这个错。

* 不知道怎么回事，可能还需要再调试？
  * reply：可能是truffle编译的问题，换成remix编译试试

## 0403_测试反馈

### 多设备访问问题

重开 `newTaxiSystem` 文件夹，重新配置区块链，在这一部分主要完成的操作为，将 `rpcaddr` 从`127.0.0.1` 修改为 `0.0.0.0`。（在初始化区块链的时候就进行修改）
> 在这里保存了原有的 `TaxiSystem` 文件夹，为了进行一些小对照，把它当成一个简单的备份。

初始化区块链：

```shell
geth1 --identity "MyEth" --rpc --rpcaddr 0.0.0.0  --rpcport "8545" --rpccorsdomain "*" --datadir gethdata --port "30303" --nodiscover --rpcapi "eth,net,personal,web3" --networkid 91036 init genesis.json
```

启动区块链：

```shell
geth1 --datadir ./gethdata --networkid 91036 --port 30303 --rpc --rpcaddr 0.0.0.0 --rpcport 8545 --rpcapi 'personal,net,eth,web3,admin' --rpccorsdomain='*' --ws --wsaddr='localhost' --wsport 8546 --wsorigins='*' --wsapi 'personal,net,eth,web3,admin' --nodiscover --allow-insecure-unlock --dev.period 1 --syncmode='full' console
```

* 有没有可能是wsaddr的错？
  * 尝试把它也改成 0.0.0.0

```shell
geth1 --datadir ./gethdata --networkid 91036 --port 30303 --rpc --rpcaddr 0.0.0.0 --rpcport 8545 --rpcapi 'personal,net,eth,web3,admin' --rpccorsdomain='*' --ws --wsaddr 0.0.0.0 --wsport 8546 --wsorigins='*' --wsapi 'personal,net,eth,web3,admin' --nodiscover --allow-insecure-unlock --dev.period 1 --syncmode='full' console
```

存一下初始化启动后的信息：
![new1](../question_pic/newBC.png)
账户信息：

```js
> eth.accounts
["0xfa1bcac63b59716eb11c158a6f2163019ad13ab0", "0x3d226b729ad1749a7880e940d5f93fa400e00712", "0x19f1d895d81c17c25693f65c78f370292dbd5ede", "0x38b7415c58741422260eddfcf34db5a46bfff49d", "0xe22422adaa49a6b1d7f0dba445b53671d7b4649d", "0x7fa325e5addc28b8db6bc91f43cf91aa3fc04717", "0xbdb403d5cac06076709556fd54a3ee7a21fb2840", "0xf1c1aa26f43f85959b09daf2ccd904d84f393ba1"]
```

解锁账户：

```javascript
for (i = 0; i < eth.accounts.length; i++) { personal.unlockAccount(eth.accounts[i],"123456",0) }
```

查看余额：

```javascript
for (i = 0; i < eth.accounts.length; i++) { console.log(eth.getBalance(eth.accounts[i])) }
```

> 需要整理进vue手册里，进行测试。

aaa！！de出来了！！！
是需要在以下地方进行修改：

1. 初始化区块链时，用 rpcaddr 0.0.0.0 进行初始化
2. 启动区块链时，用 rpcaddr 0.0.0.0 和 wsaddr 0.0.0.0
3. vue代码里进行一些修改，修改Global.vue里的全局配置，把所有如下的语句都注释掉本地访问的 ws，修改接入当前局域网

    ```javascript
    this.web3Map = new Web3(
      //new Web3.providers.WebsocketProvider("ws://127.0.0.1:8546")
      new Web3.providers.WebsocketProvider("ws://192.168.43.158:8546")
    );
    ```

1和2的目的在我的考虑中，应该是为了把区块链设置成一个公有的区块链，让所有设备都能访问。但是究竟需不需要，其实不能确定，因为在只进行1和2，未进行3的更改时，依然报 old error，理论上如果修改1、2就能起一部分作用的话，应该会有不一样的报错？但这个事情无所谓，已经能跑了，就按照能跑的做就行，至于是否要考虑1和2的修改的充分性，可以延后再议。

3的目的，在我的考虑中，应该是为了把vue的ws端口打开，它对应的是之前一直忽略的报`ws://localhost:8546`连接不上的错，修改成局域网中的8546端口后，就没问题了。

### out of gas问题

首先，我把所有使用 truffle 编译的合约都变成了使用 remix-ide 编译的合约，并对 StoreMap.json 进行了替换。

在使用 remix-ide 编译的时候，出现一个问题，即在 remix-ide 中获取的json文件们中的abi接口里都有很多很多空格，这些空格会影响geth控制台中的输入，使部署合约时出错，因此需要用removeSpace.py文件对abi接口段进行处理，将abi接口中的空格删去。

为了使用 `removeSpace.py`，首先需要建立 `old.txt` 和 `new.txt` 文件，把从 remix-ide 中获取到的abi接口放进old.txt中，再运行removeSpace.py，会在new.txt里得到输出结果，copy输出的去空格版abi接口，把它和bytecode一起进行拼接，就可以在geth里向区块链上部署。

接下来，重新打开出租车打车系统，发现此时依然报 out of gas 的错，说明大概率不是因为 truffle 编译的问题，因此，还是从代码入手。结合报错的条件分支，可以看到报错是报在和 StoreMap.sol 交互的gas中，那结合前面找到的可以运行的 StoreMap.sol 值，我将可以运行的gas移植到当前的gas处，然后发现运行正常。因此确认，后续的问题应该均可以通过此方法解决！

没问题的，在vehicle端只需要修改一处gas即可。很简单，哪里报错改哪里就好。

如果乘客端报错 out of gas，定位一下应该是getoff()中的合约交互过程出现问题，应该不是trafficContract就是pay value时出问题，反正bug定位在 `console.log("getoff() - 开始支付订单");` 和 `console.log("getoff() - 乘客支付了订单");` 之间，个人认为大概率是：sendTransaction()方法出问题，因为它给定的里程单价太高了。在九宫格地图测试的过程中，当前选定的点位不会出现这种错，应该是由于计算出的costAll较低；在真实地图测试中，当前选定的点位好像会出现这个bug，应该就是计算出的costAll太高的缘故，调低单价估计就行了。

至于地图点位的选取问题，首先优先考虑从地图生成的代码输出中选取，即输入 `node uploadmap_cjz_3.js` 之后，在控制台里会输出一系列 `gid` 和 `geohash`，在这些点位中进行选取，即可有效给vehicle、passenger部署位置，但确实需要注意，位置不能放置的太偏，一旦放太偏，就会影响寻路过程，导致路径geohash为空。

所以，初始化位置时，需要合理选取，尽量选地图靠中的位置。

```txt
nine map position ——
vehicle: wx4erxhzekd
passenger: wx4ermq0ekd to wx4erjmbekd
```

[geohash地图](https://geohash.softeng.co/wx4er)
