# msj_开发过程

> 读前须知：
>
> 1. 笔者完成毕设的过程记录，读者应首先知道，本系统由区块链服务端、终端两部分组成，终端的实现方式有Web浏览器和脚本两种。
> 2. Part1是笔者对Web终端的复现过程记录；Part2是笔者对脚本终端的复现过程记录；Part3是笔者的地图工作的过程记录；Part4是笔者的算法开发过程记录。

## Part1 复现Web终端

记录笔者的复现过程。Part1的复现是复现浏览器终端。

### 1-1 过程记录

[傅泽同学的复现手册](https://github.com/Endericedragon/ReproducingBlockchain)

[狄永正同学的复现手册](https://github.com/diyz19/GraduationDesign/tree/master/Reproduct-doc)

笔者完成的复现过程基于上述两位同学的仓库文档进行，笔者已将自己复现后补充的复现手册更新在[笔者的复现手册](https://github.com/LancerEnk/GraduationDesign/tree/main/doc/%E5%A4%8D%E7%8E%B0%E6%89%8B%E5%86%8C)中。按照实验室前期的复现工作手册，进行复现的整体过程是较为快速和顺利的，但究竟每一步为什么要按照手册那样进行，还需要读者自行探索研究。

在笔者复现的过程中，遇到如下的问题，在此对其进行记录。

### 1-2 已解决的问题

#### 环境安装问题

**Q1**：**安装node和npm的时候，卡死**

**A1**：可能是网络问题，耐心等待。如果实在是等待太久，则需要再次重新安装。

**Q2**：**显示node或者npm版本太低**

**A2**：Ubuntu的版本会决定默认安装的node、npm等一系列包的版本，因此，如果出现版本不匹配问题，首要可以考虑在terminal中重装等级低的包；如果不能重装的话，可以考虑重装虚拟机，升级Ubuntu版本。

**Q3**：**移植`geth1\geth-tree`进入`/usr/bin`中，普通用户无权限**

**A3**：[参考文档](https://blog.csdn.net/m0_59133441/article/details/122081288?ops_request_misc=%7B%22request%5Fid%22%3A%22167739817216800192264491%22%2C%22scm%22%3A%2220140713.130102334..%22%7D)，使用其中第1条的`sudo nautilus`指令，即可完成文件移动行为。

#### 复现实验1~7问题

**Q1**：**Web运行卡顿**

**A1**：

* 见[笔者的复现过程-new复现](https://github.com/LancerEnk/GraduationDesign/blob/main/doc/%E5%A4%8D%E7%8E%B0%E6%89%8B%E5%86%8C/new%E5%A4%8D%E7%8E%B0.md)中，对各问题均有详细描述和过程截图。

* 如果在完成实验7后，发现自己在浏览器前端展示出的出租车调度系统运行较为卡顿，不要担心，它就是反应很慢...主要是浏览器使用leaflet渲染地图的过程非常慢..当地图渲染完毕，并且不再移动地图、放大or缩小地图后，整个前端显示的过程就会流畅起来。

* 并且请注意，在浏览器前端中，每次移动、放大or缩小地图，其本质都是：系统相应前端发过来的鼠标操作信号，然后根据鼠标的行为重新渲染地图。因此，有可能原本已经完成初始化的车乘位置，会在地图重新渲染之后被新渲染出来的道路覆盖，导致显示的效果较差。

* 如果想对其进行修改，使每次鼠标操作之后，整个地图上显示的信息都重新渲染的话，可能需要去阅读一下道路的渲染逻辑，然后在网页的代码`（sys_vehicle_region.html和sys_passenger_region_noPos.html）`中补充地图重新渲染的逻辑。

**Q2**：**Web运行后，网页的console中报`geohash1, geohash2: undefined, undefined`**

**A2**：

* 这段报错出现在路径规划的过程中，理论上此语句正常的输出应该形如`geohash1, geohash2: 'wx4ep8e5gw0', 'wx4ep8e7ytm'`。一旦输出Q2中的情况，这意味着此组测试点位不在地图上，即说明你需要更换测试数据。

* 那么测试数据应该如何选取？
  * 首先应该从已有的地图中来，在你部署的那份地图文件里找存在的Geohash编码，这至少能保证你选取的点是地图上的点；
  * 接着，你应该根据[Geohash在线可视化网页](https://geohash.softeng.co/)来判断你选取的测试点是否处于此块地图边缘，如果在边缘，请更换测试数据，如果不在边缘，请在地图上大致浏览一下测试数据间是否有可行的道路。

* 测试数据的选取是一个类似调参的过程...要有耐心。

#### 复现实验8问题

**Q1**：**跨设备访问**

* 在复现万琦玲的出租车调度系统时，笔者主要遇到的问题是她所提及的跨设备访问系统问题。
  * 在前期的复现工作中，实验室一直将区块链部署在本地，大家各自搭建一条私链，在自己的私链上运行系统，从未尝试过跨设备访问区块链。

**A1**：

* 解决方法：从初始化区块链时就开始修改相关代码。
  * 具体的解决过程见[8 vue实现的调度系统复现实验](../%E5%A4%8D%E7%8E%B0%E6%89%8B%E5%86%8C_CJZandWQL/8%20vue%E5%AE%9E%E7%8E%B0%E7%9A%84%E8%B0%83%E5%BA%A6%E7%B3%BB%E7%BB%9F%E5%A4%8D%E7%8E%B0%E5%AE%9E%E9%AA%8C.md)

### 1-3 未解决的问题

**Q1**：**`实验1 传统区块链初始化和启动`中笔者遇到的bug**

问题描述：在使用ganache-cli模拟时，与智能合约交互的网页可以正常完成；在使用本地部署的区块链时，在部署智能合约的时候显示“NetWork：NAN”。

没能解决此问题，笔者也没有使用本地部署的区块链再次对此bug进行复现修正。

## Part2 复现脚本测试终端

本部分主要聚焦于，在已完成Part1工作的基础上，开始使用测试脚本终端对系统的数据进行获取整理。因此，此部分复现没出什么大问题，主要是通过脚本获取数据。

### 2-1 过程记录

这个过程很简单，完成以下过程：`启动区块链 -> 部署合约 -> 修改代码中对应的合约地址 -> 上传地图`，然后开启脚本测试终端。

### 2-2 已解决的问题

**Q1**：**Timeout报错**

**A1**：

* 问题截图如下。该问题其实不只是在Part2中会出现，在Part1中也会出现。

    ![timeout1](../%E4%BA%A4%E6%B5%81%E6%96%87%E6%A1%A3/timeout1.png)

    ![timeout2](../%E4%BA%A4%E6%B5%81%E6%96%87%E6%A1%A3/timeout2.png)

* 据笔者观察，该问题的出现可能有以下的原因：
  * 笔者的笔记本电脑配置较低，型号为`intel CORE i5 - 8th Gen`，`8G+512G`，轻薄本，笔者未扩展其内存。因此，笔者在配置虚拟机时，给虚拟机安排的配置是`5G+30G`左右的配置，有可能该配置相对于本系统来说较低。所以，在笔者试图一边运行系统（无论是Web终端还是脚本测试终端）、一边运行录屏操作时，终端就会狂报 “Timeout” 的错。看起来是因为主机分给录屏操作的资源占用较大，导致虚拟机中系统的运行受到影响。值得一提的是，一边运行系统、一边开着腾讯会议共享屏幕，尽管对系统的运行也有影响，但该影响较小，几乎可以视作正常运行（奇怪的...我还以为腾讯会议也很占资源呢`:)`...）。

* 对于本问题的解决方法，有以下几个层面。
  * 首先，如果你有能力，可以尝试在配置更高的机器上运行本系统。
  * 其次，可以试图去在区块链的底层寻找抛出 “Timeout” 的对应代码，据笔者分析，这个`Timeout=5s`应该是某个默认的限制交互时间，但由于不清楚终端中的交互操作在资源占用的情况下到底需要耗时多久，因此笔者不能给出一个`Timeout=xs`中x的具体数值。
  * 最后，是 “掩人耳目” 式的做法。分析抛出异常的前端中给出的代码定位，发现这是在每次运行pickUp()和manageToEnd()时，一旦调用失败，则抛出该异常。因此笔者在抛出异常的`console.log("astar err:",err);`后面重复调用pickUp()、manageToEnd()过程，实现如下思路：一旦抛出异常，则立刻重新运行该段交互代码，不断重开，总有一次能运行的通...这种办法有用，但治标不治本，因此如果你有时间and能力，笔者建议你从根源处解决该问题。

### 2-3 未解决的问题

无

## Part3 地图

### 3-1 过程记录

在获取地图数据时，笔者主要依靠实验室前期几位前辈的工作记录入手，该记录链接如下：

* [成佳壮的开发文档中，对地图数据部分的记录](https://github.com/oscourse-tsinghua/investigation-cjzhuang2020/blob/main/%E8%B0%83%E5%BA%A6%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.md)

* [对应的说明文件地址 - 邱皓月的环境部署说明](https://github.com/oscourse-tsinghua/vanet-DTrafficMining2018/blob/master/%E9%82%B1%E7%9A%93%E6%9C%88%E5%AD%A6%E4%BD%8D%E8%AE%BA%E6%96%87%E7%BB%93%E6%9E%9C%E6%95%B4%E7%90%86/1.%E9%A1%B9%E7%9B%AE%E5%B7%A5%E4%BD%9C%E7%BB%93%E6%9E%9C/%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E5%B8%AE%E5%8A%A9.txt)

但前辈们使用的地图数据较为陈旧，因此笔者为了处理近期内的北京市地图数据，决定跳出前辈们的过程，自己蹚一条新路出来。

笔者对地图数据的处理过程如[笔者给出的地图获取过程](../%E5%9C%B0%E5%9B%BE%E6%95%B0%E6%8D%AE%E8%AF%B4%E6%98%8E/%E8%8E%B7%E5%8F%96%E7%9C%9F%E5%AE%9E%E5%9C%B0%E5%9B%BE%E6%95%B0%E6%8D%AE.md)中所示。在此过程中，笔者使用ArcGIS、PostgreSQL软件，获取了北京2023年4月份的OpenStreetMap地图数据，并将其成功转化且上传给区块链，完成了系统的运行测试。

### 3-2 已解决的问题

**Q1**：**经纬度定位的问题**

* 问题描述：依据从百度开源地图上获取的经纬度，在PostgreSQL中进行筛选，得出的道路，在经过脚本处理为Geohash编码后，有1/3都是该区域外的。

**A1**：

* 出现原因分析：OpenStreetMap所使用的坐标系与百度地图的坐标系不同，因此二者测算出的经纬度不同。

* 解决方法：直接在OpenStreetMap上框选经纬度，笔者是打开ArcGIS选定的经纬度范围，并在PostgreSQL中进行修改。

### 3-3 未解决的问题

**Q1**：**其实可以考虑将数据库中的speed字段也上传给区块链**

**A1**：

* speed字段应该指的是现实中的道路限速，是由OpenStreetMap得来的。

* 囿于笔者的时间原因，没有机会将speed属性作为地图的固有属性，从地图数据文件中上传给区块链；而是简单的使用智能合约对道路speed进行指定。

* 如果读者对此有兴趣，可以尝试修改地图上传脚本，通过地图数据指定 $V_{default}$，这样显然更接近真实场景。

## Part4 算法

### 4-1 过程记录

#### 阅读合约代码，大致考虑实现逻辑

整理了不同的结构体、mapping映射、函数的逻辑，然后对整体的StoreMap.sol代码进行了精读，读懂了80%，上手开始修改代码。

#### 0504给出第一版算法

改出第一版代码，出现问题了。

在没有外部资源占用的情况下，终端疯狂报Timeout的错。

判断，导致此Timeout的错可能有这几种：

1. 找不到路？
  
    * 用方格地图测一下，看看什么效果。
    * 用真实地图测，找个道路复杂且短的区域 - 海淀黄庄新中关那里。
    * 是寻路逻辑出问题了？

2. 应该用send调用，而不是call调用？

3. 合约中出现死循环？
    * bug定位是在mapContract的astar()中。

在方格地图上运行，打印costAll，发现它永远不变，寻出来的路也不变，但抛出Timeout错的次数少了。

经排查，问题出在寻路逻辑部分。因此，重新阅读StoreMap.sol中原本就有的代码，其中astar()是关键函数。

捋了A*算法的逻辑，把StoreMap.sol中的astar()分为了计算成本部分、回溯道路部分。

并确认我需要在代码中找出`"用geohash定位路段"`的方式。

修改代码，运行测试。

寻路结果发生改变了，但是改变的结果和预想中的效果大相径庭。在组会跟老师讨论过后，认为可能需要在更小的方格地图上对道路进行测试。

新的一天，首先修改了合约里`"用geohash定位路段"`的过程，在系统中测试。

发现costAll又不动了...

不知道是啥的问题...在终端部分把astar()从call()改成send()了。

报了个exceed gas limit的错。修好了。

但是还不对，因此去重新捋一遍。

阅读了一下`.send()`和`.call()`的区别，然后意识到，应该把计算更新实时路况和A\*寻路的过程划分开。因为实时路况在更新后是需要写进区块链的数据里的，但A\*寻路可以只对区块链的数据进行read，不用更改数据。

新的一天：

* 更新了合约里的部分数据，修正逻辑bug
* 修改网页内容：
  * calTraffic的次数
  * 删除画点时候的sleep(100)

手动模拟了一下路况更新的过程。

在方格地图上找点，方格地图特性：最后3位都是ekd；前5位都是wx4er。

选定测试数据：

* passenger start：wx4erq8zekd
* vehicle start / passenger end：wx4erq8zekd

在方格地图上测试，发现寻得的路依然不变...气死我了

决定换一下测试数据和地图大小，把地图变成7*7的格，然后选定测试数据：

选定测试数据：

* passenger start：wx4erxjzekd
* vehicle start / passenger end：wx4erjmbekd

能动了！但动的不太对啊...

开始print大法.........（虽然理论上来说在这里应该是console.log大法啊啊啊啊啊啊啊啊啊啊啊）

没法通过Remix-ide直接对智能合约进行debug，那就开系统在前端直接console.log一切我想console.log的东西吧...

* 设计输出路况相关的 $V_{current}$,$V_{default}$,$V_{history}$,$V_{fact}$ 。

* 设计输出backwards、costAll、thegid。

发现以costAll为主，costAll的输出异常，因此考虑是否在A*算法逻辑部分出问题。

重新捋一下代码逻辑，由于现在这版代码已经被写乱了，重写一版，把所有已完成的内容推倒，捋清楚之后重新来一遍。

新逻辑：在StoreMap.sol中设计updatePathSituation()、修改astar()。

updatePathSituation()：从终端接住上一轮道路规划结果，根据规划结果的geohash匹配对应的道路gid，根据gid做以下事：初始化车速度、计算path速度、计算路况。按照gid把道路路况上传给区块链，在区块链中更新数据。计数，统计路况更新次数。调用时用send()。

astar()：道路规划过程，在规划时计算新的F(n)，大的代码不需要变，只需要修改核心的 $F(n)=G(n)+H(n)$ 为 $F(n)=G(n)+H(n)+C(n)$。【一些来自后期的吐槽...所以这个时候改F(n)并没有改对啊啊啊啊啊啊】

运行，发现costAll不变。

开始debug。

* 排查sGtG有无正常映射
  * 传小地图，调用testsGtG()，查看是否正常输出映射关系。
  * √
* 查传参问题。是否存在可能：给updataPathSituation()传的参数不对，导致updatePathSituation()无法根据sGtG[geohash]的映射关系映射去对应的道路gid，从而更新道路路况？
  * 发现传参确实有问题。
  * 尝试换成ASCIItoHEX，输入blockchain
  * 出现out of gas报错，会不会是合约里出现死循环？
    * 有可能
  * 传参部分想起来成佳壮学长提到过64位16进制问题
    * 好像真是这里的问题。
    * 在终端里对astarOriginRoute和astarRoute做相应扩展为64位16进制的处理，把新的debugRoute传回给updatePathSituation()，成功了！合适了！
  * √
  * 归根到底，是合约里的bytes32对应的必须是卡死的64位16进制数值，少一位都不行，所以必须提前做好处理再交回给合约。
* 查updatePathSituation()
  * 查每轮之后所有speed的更新情况
  * 有更新
  * √
* 查calPathCostToAdd()
  * √
* $V_{Fact}$ 收敛好快
  * 哦是合约里公式写错了，改好了
  * √
* 查astar()传参，psCost有变化，costAll没变化
  * sGtG功能正常，前面查过了
  * costAll计算逻辑正常？
    * 再捋一下逻辑，好像newcost更新有问题，我没改全？
    * 对是没改全，改了
  * 因为没路走？
    * 不能吧...
* 又报out of gas了...
  * 是因为我的output或者input有问题？
  * 删掉output和input的两部分，哦确实没问题了
* costAll一直有变化，但是在地图上没变路？？？？为啥规划的路径不动啊？？？
  * 道路重复了？
  * 没进astar()的if(||)导致结果不变？
  * 地图边缘？
  * 换个地图试试吧...
    * ？？？好了？？？
    * 那看来是3*3的地图太小了，点也没选好...
* 在7*7的方格地图上运行，看起来没问题
* 进数据获取and分析阶段吧...

#### 0514给出第二版算法 + 盲审论文ddl（0518）

给出新改完bug的算法

**0514反馈**：

* 跑一点好看的截图出来
* 可以给路线画个箭头

**0514-0517**：

* 分析数据
  * costAll - √
* 完善论文内容
  * 摘要 - √
  * 结论 - √
  * 写致谢 - √
  * 后一半实验 - √
  * 代码块有点丑，看看调个格式 - √

**0517反馈1**：

* 实验部分不太行，写的很含糊，禁不起问，而且针对一个算法的好坏，根本没有测试数据，单薄
  * 复杂度怎么算？
    * 智能合约 - gas值反映
      * 在合约里用gasleft()计算差值，并返回结果
  * 那输出一下时间 and gas

盲审版论文来不及补充更多数据了啊啊啊啊啊啊啊啊啊啊啊啊啊啊来不及了！！！！！

**0517反馈2**：

改结构

**0518按照反馈改论文，交盲审**。

**0519自定任务**：

* 画箭头
* 计算实时路况更新用时 - 证明耗时是可接受的
  * if timeout 就直接重新调用
  * √ 可以的，在Web里有输出
* 证明路是对的？ - 输出邻居表？ - 改合约
  * 代码里不知道咋改，先放着吧
* 有无可能用wql的框架 - 可能来不及整理了...
  * 来不及了
* 改自动化测试脚本 - 获取更多数据
  * 要用自动化测试脚本获取gas差值、时间
    * gas差值：统计旧A\*复杂度、新A\*复杂度
    * updatePathSituation()用时，在js里统计，send前后各计一次时
  * 分析一下输出的内容，差输出了...

**0520 - 画箭头**：

尝试了各种办法...发现Web终端的map好像完全被用geohash接管了...但箭头是经纬度的画法，这俩没法混搭，如果要把箭头画成geohash画法，就需要去leaflet改底层；如果执意要拿经纬度画箭头，还想让箭头显示，就必须把map还原为经纬度接管，这不可能。

乱搭会爆栈，前端地图的渲染会崩溃。

短期内做不来...算了，放过它。

**0521 - 跑新的数据**：

设计对比数据，设计测试方法，修改测试脚本。

跑实验。

好晚了啊啊啊啊啊啊啊啊23：00+才跑完的数据........

完蛋了要熬夜了啊啊啊啊啊啊啊熬夜整理数据吧唉唉唉唉唉唉

**0522 - 数据整理完毕，修改论文里的对应部分**：

* 第4章 - √
  * 开头：实验环境
  * 4.3 性能测试
* 改所有提到第4章的地方 - √
* 改图、表格式、颜色 - √
* 改摘要 - √
* 参考文献再对一遍 - √
* R2和Round2的统一口径 - √
* 23号预答辩，做ppt

**0523 - 预答辩反馈/答辩前夜**：

早上：ppt做完了；下午三点预答辩，紧张紧张紧张。

预答辩反馈：（16：30的反馈意见）

* ppt：别用正确性、实用性、真实性这种绝对的词。
* 辅以动画之类的
* 结构
* 视频重录

  ```txt
  1. P10 ：需要先讲结构再说每个部分的工作；
  2. P13：可以用动画把模块与公式的对应关系；
  3. 真实、合理、正确：多次出现，但我认为说得太满了。
  4. P23: 这些内容可以用字幕的形式加到视频中，外部拍摄可以换成录屏。 @蒙思洁
  ```

面包 + 奶茶对付当晚饭吧，别正经吃了没时间了...赶紧修改...

先从论文开始改吧...论文交的早...论文和ppt里提到“正确性”这种地方都得改...

论文改完21：30了...没时间改ppt再模拟一轮了...

改ppt改到12点...怎么还有这么多没改...

先整理答辩时候提交的材料吧...

两点了...哦运行视频还没重录救命救命救命朋友电脑快没电了救命

赶在电脑8%的电量的时候把视频录完了救命，二十分钟的视频我怎么搞啊啊啊啊啊

算了继续改ppt吧，要把ppt给答辩组拿邮件发过去...

改改改改改改完ppt早上六点了已经...看看视频怎么办...

傅泽说可以用blender部分快进视频...我没用过blender啊啊啊啊啊啊啊救命

哦哦哦速成一下速成一下好像可以的

哦七点了！视频搞好了！压到4min了！！！

交交交快去给老师邮箱里交答辩ppt！！！极限！！！极限擦线提交！！！

通了个宵没睡觉好像不太困啊...论文还没打印，不知道打印店开门没开...

开了开了！！！印印印彩印好贵啊啊啊啊啊啊啊啊啊！！！

完了完了完了我ppt还没模拟顺...完了实验室其他同学已经被叫过去候场了啊啊啊啊啊啊啊啊啊怎么办怎么办怎么办

完了完了完了快到我了啊啊啊啊啊啊啊

完了完了完了到我了

完了答完了

好像不困不太着急补觉，晚饭没吃，早饭没吃，好像不太饿，中午吃披萨得了:)

### 4-2 已解决的问题

**Q1**：**exceed gas limit**

**A1**：在geth控制台里使用`eth.getBlock(x)`获取第x块区块的gas limit，发现基本都是23860000+，但在我的html代码里给出的是50000000000，严重超了...就在html里把gas给到小于23860000的数字，此报错解决。

**Q2**：**out of gas的猜想**

**A2**：根据笔者猜测，仿佛这个报错有以下原因“

* 合约里写了个死循环，这个时候就会狂消耗gas，然后报out of gas
* 合约里某个函数的输入or输出不对，会报这个错

### 4-3 未解决的问题

**Q1**：**Web前端的地图上进行更多绘制**

**A1**：需要在leaflet的源码部分进行修改，将传统的经纬度leaflet绘制过程变更为geohash绘制过程，这需要去读and改源码了。

**Q2**：**输出每个位置的邻居表的F(n)，用于证明道路选取的正确性**。

**A2**：按照笔者的估计，需要在合约中进行修改，遍历一下邻居，输出所有邻居的F(n)，再跟最后输出的astarRoute对比一下，看看是否具有最小F(n)的邻居在规划的路径中？

**Q3**：**整合进wql的前端里去，实现多设备访问最新的运行系统效果**。

**A3**：就...我没空整了...sad
