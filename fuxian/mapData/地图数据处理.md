# 地图数据处理

## 九宫格地图数据处理

### 代码的下载

代码文件存放地址：https://github.com/LancerEnk/GraduationDesign/tree/main/fuxian/mapData/nineMap

在此GitHub仓库链接中，获取 `roadGenerate.js` 文件内容，然后复制粘贴到成佳壮学长源代码的 `investigation-cjzhuang2020/cjz_underg_2021_09/tree_blockchain` 文件夹下，即可正常在复现环节中使用地图。

此仓库中的 `55_ninemap_GeoHash.json` 和 `1010_ninemap_GeoHash.json` 是我按照 rowCol(8,8) 和 rowCol(16,16) 生成的九宫格地图，具体在 `本md文件中 - 章节:代码的修改` 有解释。

九宫格测试地图数据的处理，通过/home/mmm/investigation-cjzhuang2020/cjz_underg_2021_09/tree_blockchain中的roadGenerate.js脚本完成。

### 代码的修改

> 对这个脚本的说明 ↓

在自己生成地图时，要关注修改的地方有以下几处：

1. 第9行，`let gname = './1010_ninemap_GeoHash.json';`
    * `gname`：生成的九宫格地图的名称为 gname。
    * 在使用 `uploadmap_cjz_3.js` 上传地图时，在 `uploadmap_cjz_3.js` 文件中的 map_gile 变量名需等于 gname
2. 第72行，`rowCol(17,17)` 对应想设置的地图大小。
    * 具体的大小可以参见![map1](./question_pic/map1.jpg)中的示意图。
3. 第73行、第74行，两个 `console.log` 语句，对应的是我的调试输出，其输出的是生成的九宫格地图的长和宽。
4. 第80行、第81行，deltaLon 和 deltaLat 变量对应的是 $Δ_{经度}$ 和 $Δ_{纬度}$
    * 这个是按照cjz学长的源代码走的，他的代码中，原本是1：2的比例，为了设计成正方形，我调整成1：1的比例了。
    * 这个数据也许是随便设的？我没深入研究这个数据是怎么得到的。
        * 说不定可以根据`s=5km`的要求，反推 `Δ = 几` 哈哈哈
5. 第408行，function getDistanceBtwP()对应的就是距离计算函数。
    * 在第72行的输出中，就调用了这个函数进行计算。

### 九宫格地图的生成

在 `roadGenerate.js` 所在的文件夹中，右键运行 `terminal`，然后在弹出的终端窗口中，输入启动脚本的代码：

```shell
node roadGenerate.js
```

静待输出，最后一行输出 `work` 并推出运行，即说明地图生成成功。

## 真实地图数据处理

> 本来是希望今天(0411)晚上去找成佳壮学长询问一下，他对于真实地图的处理方法是否如下，但是没有联系到，因此未果，先做记录整理。

真实地图的处理过程，大约如下：

[成佳壮的开发文档中，对地图数据部分的记录](https://github.com/oscourse-tsinghua/investigation-cjzhuang2020/blob/main/%E8%B0%83%E5%BA%A6%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3.md)

* 迅速定位：
  * 需要在页面搜索以下内容：`AllocationRoadsegment cur_road=new AllocationRoadsegment(gid,maxspeed, 10.0, 0)`
  * 在搜到这个内容以后，其后续的很长一串内容，基本上都是关于地图数据处理的过程。
* **阅读结果**：
  * **对真实的北京地图数据的处理**（猜测）：
    * 在 `openstreetmap` 中获取中国数据，剪裁出北京数据，把该数据导到 `PostgreSQL` 数据库里，然后在这个数据库里对北京的地图数据进行处理，比如按类型、按范围筛选（用数据库语句筛选）。
      * 筛选时，凭借经纬度计算距离，用数据库语句进行筛选，应该可以得到固定范围的真实地图数据。
      * 筛选时，对类型进行指定，应该可以获取到想要的不同类数据？
        * 比如纯道路数据 `"type":"LineString"`
    * **存在疑问**：
      * 由于我没有正式开始通过此方法处理地图数据，所以我不知道通过数据库筛选出来的内容是什么，因此我暂时不知道筛选出来的结果要如何变成对应的 `地图json文件`。
      * 以及配这一连串相关的环境...仿佛又是个麻烦事(QAQ)
  * [北京市osm道路数据下载地址](https://github.com/xyongcn/BalanceRouting4RealtimeTraffic/tree/master/map)
    * [对应的说明文件地址 - 邱皓月的环境部署说明](https://github.com/oscourse-tsinghua/vanet-DTrafficMining2018/blob/master/%E9%82%B1%E7%9A%93%E6%9C%88%E5%AD%A6%E4%BD%8D%E8%AE%BA%E6%96%87%E7%BB%93%E6%9E%9C%E6%95%B4%E7%90%86/1.%E9%A1%B9%E7%9B%AE%E5%B7%A5%E4%BD%9C%E7%BB%93%E6%9E%9C/%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E5%B8%AE%E5%8A%A9.txt)
